name: Nexus 24/7 Multi-Node Runner

on:
  workflow_dispatch:
    inputs:
      force_restart:
        description: 'Force restart all nodes'
        required: false
        type: boolean
        default: false
  schedule:
    - cron: '0 */4 * * *'  # Auto-trigger every 4 hours

env:
  MAX_ITERATIONS: 100
  RESTART_DELAY: 10
  NODE_TIMEOUT: 5h

concurrency:
  group: nexus-${{ github.ref }}-${{ github.run_number }}
  cancel-in-progress: false

jobs:
  setup-matrix:
    name: ğŸ”§ Setup Node Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.parse.outputs.matrix }}
      total: ${{ steps.parse.outputs.total }}
      timestamp: ${{ steps.parse.outputs.timestamp }}
    steps:
      - name: Parse Node Configuration
        id: parse
        run: |
          set -euo pipefail
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ” PARSING NEXUS CONFIGURATION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Validate secrets exist
          if [ -z "${NEXUS_NODE_IDS:-}" ]; then
            echo "âŒ CRITICAL: NEXUS_NODE_IDS secret not set!"
            echo ""
            echo "ğŸ“‹ SETUP INSTRUCTIONS:"
            echo "1. Go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo "2. Add secret: NEXUS_NODE_IDS"
            echo "3. Format: one node ID per line (newline-separated)"
            echo ""
            exit 1
          fi
          
          if [ -z "${NEXUS_WALLETS:-}" ]; then
            echo "âŒ CRITICAL: NEXUS_WALLETS secret not set!"
            exit 1
          fi
          
          # Parse node IDs
          mapfile -t NODE_IDS < <(echo "$NEXUS_NODE_IDS")
          mapfile -t WALLETS < <(echo "$NEXUS_WALLETS")
          
          NODE_COUNT=${#NODE_IDS[@]}
          WALLET_COUNT=${#WALLETS[@]}
          
          echo "âœ… Loaded $NODE_COUNT node IDs"
          echo "âœ… Loaded $WALLET_COUNT wallets"
          
          if [ "$NODE_COUNT" -ne "$WALLET_COUNT" ]; then
            echo "âŒ ERROR: Node IDs ($NODE_COUNT) and Wallets ($WALLET_COUNT) count mismatch!"
            exit 1
          fi
          
          if [ "$NODE_COUNT" -eq 0 ]; then
            echo "âŒ ERROR: No nodes configured!"
            exit 1
          fi
          
          # Build JSON matrix
          MATRIX_ITEMS=""
          for i in $(seq 0 $((NODE_COUNT - 1))); do
            NODE_ID="${NODE_IDS[$i]}"
            WALLET="${WALLETS[$i]}"
            
            if [ -z "$NODE_ID" ] || [ -z "$WALLET" ]; then
              echo "âš ï¸  Skipping empty entry at index $i"
              continue
            fi
            
            ITEM=$(cat <<EOF
          {
            "index": $((i + 1)),
            "node_id": "$NODE_ID",
            "wallet": "$WALLET"
          }
          EOF
          )
            
            if [ -n "$MATRIX_ITEMS" ]; then
              MATRIX_ITEMS="$MATRIX_ITEMS,"
            fi
            MATRIX_ITEMS="$MATRIX_ITEMS$ITEM"
          done
          
          MATRIX=$(cat <<EOF
          {
            "include": [$MATRIX_ITEMS]
          }
          EOF
          )
          
          echo "matrix<<EOF" >> "$GITHUB_OUTPUT"
          echo "$MATRIX" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
          
          echo "total=$NODE_COUNT" >> "$GITHUB_OUTPUT"
          echo "timestamp=$(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> "$GITHUB_OUTPUT"
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Matrix setup complete: $NODE_COUNT nodes"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        env:
          NEXUS_NODE_IDS: ${{ secrets.NEXUS_NODE_IDS }}
          NEXUS_WALLETS: ${{ secrets.NEXUS_WALLETS }}

      - name: Validate Matrix
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š MATRIX VALIDATION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          MATRIX='${{ steps.parse.outputs.matrix }}'
          TOTAL='${{ steps.parse.outputs.total }}'
          
          echo "$MATRIX" | jq '.'
          
          echo ""
          echo "ğŸ”¢ Total Nodes: $TOTAL"
          echo "â° Timestamp: ${{ steps.parse.outputs.timestamp }}"
          echo ""
          
          NODE_COUNT=$(echo "$MATRIX" | jq '.include | length')
          
          if [ "$NODE_COUNT" -ne "$TOTAL" ]; then
            echo "âŒ ERROR: Matrix length ($NODE_COUNT) != total ($TOTAL)"
            exit 1
          fi
          
          for i in $(seq 0 $((NODE_COUNT - 1))); do
            INDEX=$(echo "$MATRIX" | jq -r ".include[$i].index")
            NODE_PREVIEW=$(echo "$MATRIX" | jq -r ".include[$i].node_id" | head -c 10)
            WALLET_PREVIEW=$(echo "$MATRIX" | jq -r ".include[$i].wallet" | head -c 10)
            
            if [ -z "$INDEX" ] || [ "$INDEX" == "null" ]; then
              echo "âŒ ERROR: Node $i missing index"
              exit 1
            fi
            
            echo "  âœ“ Node #$INDEX: node=${NODE_PREVIEW}... wallet=${WALLET_PREVIEW}..."
          done
          
          echo ""
          echo "âœ… All nodes validated"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  run-nodes:
    name: ğŸš€ Node #${{ matrix.index }}
    needs: setup-matrix
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours max
    strategy:
      max-parallel: 20    # GitHub free tier limit
      fail-fast: false
      matrix: ${{ fromJson(needs.setup-matrix.outputs.matrix) }}
    
    steps:
      - name: ğŸ–¥ï¸ System Info
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸš€ NEXUS NODE STARTUP"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“ Node Index  : ${{ matrix.index }} / ${{ needs.setup-matrix.outputs.total }}"
          echo "â° Started at  : ${{ needs.setup-matrix.outputs.timestamp }}"
          echo "ğŸ”‘ Node ID     : ${NODE_ID:0:10}...${NODE_ID: -6}"
          echo "ğŸ’° Wallet      : ${WALLET:0:10}...${WALLET: -6}"
          echo "ğŸ–¥ï¸ Runner      : $(hostname)"
          echo "ğŸŒ Public IP   : $(curl -s ifconfig.me || echo 'N/A')"
          echo "ğŸ’¾ Disk Space  : $(df -h / | awk 'NR==2 {print $4}') available"
          echo "ğŸ§  Memory      : $(free -h | awk 'NR==2 {print $7}') available"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        env:
          NODE_ID: ${{ matrix.node_id }}
          WALLET: ${{ matrix.wallet }}

      - name: ğŸ“¦ Install Nexus CLI
        run: |
          set -euo pipefail
          
          echo "ğŸ“¥ Downloading Nexus CLI..."
          
          DOWNLOAD_URL="https://cli.nexus.xyz/install.sh"
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -fsSL "$DOWNLOAD_URL" -o install.sh; then
              echo "âœ… Download successful"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "âš ï¸ Download failed, retry $RETRY_COUNT/$MAX_RETRIES in 5s..."
                sleep 5
              else
                echo "âŒ Download failed after $MAX_RETRIES attempts"
                exit 1
              fi
            fi
          done
          
          chmod +x install.sh
          
          echo "ğŸ”§ Installing Nexus CLI (non-interactive)..."
          NONINTERACTIVE=1 ./install.sh
          
          rm -f install.sh
          
          # Source profile to get nexus-cli in PATH
          if [ -f "$HOME/.profile" ]; then
            source "$HOME/.profile"
          fi
          
          # Verify installation
          if command -v nexus-cli &> /dev/null; then
            echo "âœ… Nexus CLI installed successfully"
            nexus-cli --version 2>/dev/null || echo "ğŸ“¦ Version: latest"
          else
            echo "âŒ Installation verification failed"
            exit 1
          fi

      - name: ğŸš€ Run Node with Auto-Restart Loop
        run: |
          set -euo pipefail
          
          echo "ğŸ¯ Starting Nexus Node #${{ matrix.index }}..."
          echo ""
          
          # Cleanup function
          cleanup() {
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âš ï¸ SHUTDOWN SIGNAL RECEIVED"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "â° Time: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "ğŸ›‘ Stopping node gracefully..."
            
            pkill -TERM -f nexus-cli 2>/dev/null || true
            sleep 5
            pkill -KILL -f nexus-cli 2>/dev/null || true
            
            echo "âœ… Node stopped"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            exit 0
          }
          
          trap cleanup SIGINT SIGTERM SIGHUP
          
          # Main loop variables
          RESTART_COUNT=0
          TOTAL_RUNTIME=0
          NODE_ID="${{ matrix.node_id }}"
          WALLET="${{ matrix.wallet }}"
          
          # Source environment
          if [ -f "$HOME/.profile" ]; then
            source "$HOME/.profile"
          fi
          
          # Main restart loop
          while [ $RESTART_COUNT -lt $MAX_ITERATIONS ]; do
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            printf "â•‘ ITERATION #%-3d of %-3d                        â•‘\n" $((RESTART_COUNT + 1)) "$MAX_ITERATIONS"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "â° Timestamp     : $(date '+%Y-%m-%d %H:%M:%S')"
            echo "ğŸ“Š Total Runtime : $((TOTAL_RUNTIME / 3600))h $((TOTAL_RUNTIME % 3600 / 60))m"
            echo "ğŸ”‘ Node ID       : ${NODE_ID:0:10}...${NODE_ID: -6}"
            echo "ğŸ’° Wallet        : ${WALLET:0:10}...${WALLET: -6}"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            
            START_TIME=$(date +%s)
            
            # Register user (idempotent)
            echo "ğŸ“ Registering wallet..."
            nexus-cli register-user --wallet-address "$WALLET" 2>&1 | head -n 5 || {
              echo "âš ï¸ Registration response (continuing anyway)"
            }
            
            sleep 2
            
            # Start node with timeout
            echo "â–¶ï¸ Starting nexus-cli (timeout: $NODE_TIMEOUT)..."
            echo ""
            
            timeout $NODE_TIMEOUT nexus-cli start --node-id "$NODE_ID" --headless 2>&1 | while IFS= read -r line; do
              echo "[Node #${{ matrix.index }}] $line"
            done || {
              EXIT_CODE=$?
              END_TIME=$(date +%s)
              ITERATION_RUNTIME=$((END_TIME - START_TIME))
              TOTAL_RUNTIME=$((TOTAL_RUNTIME + ITERATION_RUNTIME))
              
              echo ""
              echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
              echo "âš ï¸ Node stopped with exit code: $EXIT_CODE"
              echo "â±ï¸ Iteration runtime: $((ITERATION_RUNTIME / 60))m $((ITERATION_RUNTIME % 60))s"
              
              case $EXIT_CODE in
                124)
                  echo "â±ï¸ Timeout reached (expected for periodic restart)"
                  ;;
                0)
                  echo "âœ… Clean exit"
                  ;;
                *)
                  echo "âŒ Unexpected exit. Waiting 30s before retry..."
                  sleep 30
                  ;;
              esac
            }
            
            ((RESTART_COUNT++))
            
            if [ $RESTART_COUNT -lt $MAX_ITERATIONS ]; then
              echo ""
              echo "â³ Cooldown period: $RESTART_DELAY seconds..."
              sleep $RESTART_DELAY
            fi
          done
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ›‘ MAX RESTART LIMIT REACHED ($MAX_ITERATIONS)"
          echo "ğŸ“Š Total Runtime: $((TOTAL_RUNTIME / 3600))h $((TOTAL_RUNTIME % 3600 / 60))m"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        env:
          MAX_ITERATIONS: ${{ env.MAX_ITERATIONS }}
          RESTART_DELAY: ${{ env.RESTART_DELAY }}
          NODE_TIMEOUT: ${{ env.NODE_TIMEOUT }}

  monitor:
    name: ğŸ“Š Health Monitor
    needs: [setup-matrix, run-nodes]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate Report
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘      NEXUS NODES HEALTH REPORT                â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š Workflow Summary:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ğŸ”¢ Total Nodes : ${{ needs.setup-matrix.outputs.total }}"
          echo "ğŸ“… Started at  : ${{ needs.setup-matrix.outputs.timestamp }}"
          echo "â° Finished at : $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "ğŸ“ˆ Job Results:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "âœ… Success    : ${{ needs.run-nodes.result == 'success' }}"
          echo "âŒ Failure    : ${{ needs.run-nodes.result == 'failure' }}"
          echo "âš ï¸ Cancelled  : ${{ needs.run-nodes.result == 'cancelled' }}"
          echo "â­ï¸ Skipped    : ${{ needs.run-nodes.result == 'skipped' }}"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          if [ "${{ needs.run-nodes.result }}" == "success" ]; then
            echo "âœ… All nodes completed their cycle successfully!"
            exit 0
          elif [ "${{ needs.run-nodes.result }}" == "failure" ]; then
            echo "âŒ Some nodes failed. Check individual job logs."
            echo "ğŸ’¡ Common issues:"
            echo "   â€¢ Invalid node IDs or wallets"
            echo "   â€¢ Network connectivity problems"
            echo "   â€¢ Nexus CLI installation failures"
            exit 1
          elif [ "${{ needs.run-nodes.result }}" == "cancelled" ]; then
            echo "âš ï¸ Workflow was cancelled manually."
            exit 0
          else
            echo "â„¹ï¸ Workflow status: ${{ needs.run-nodes.result }}"
            exit 0
          fi
